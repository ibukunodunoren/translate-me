<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="../css/style.css" />
        <script type="text/javascript" src="worker_handler.js"></script>

        <title>Translate - Translate Me</title>
        <link rel="icon" type="image/x-icon" href="sentiment/meh.png">
    </head>

    <body>
        <div class=navbar>
            <div class=logo>
                <a href="index.html"><h1>Translate Me</h1></a>
            </div>
            <div class=nav-links>
                <a href="about.html">About</a>
                <a href="https://github.com/ibukunodunoren/translate-me">GitHub</a>
                <a href="https://devpost.com/software/pending-ktcxao">Devpost</a>
            </div>
        </div>
        
        <div class=content>
            <div class=content-card>
                <div class=content-title>
                    <h2>English Transcript</h2>
                </div>
                <p id="english-transcript"></p><br>
            </div>
            
            <div class=content-card>
                <div class=content-title>
                    <h2>Translated Transcript</h2>
                </div>
                <p id="translated-transcript"></p><br>
            </div>
            
            <div class=content-card>
                <div class=content-title>
                    <h2>Sentiment</h2>
                </div>
                <div class=sentiment>
                    <div class=sentiment-card>
                        <h3>Speaker 1</h3>
                        <img id=sentiment_img_1 src="/public/sentiment/circle.png"></img>
                    </div>
                    
                    <div class=sentiment-card>
                        <h3>Speaker 2</h3>
                        <img id=sentiment_img_2 src="./assets/sentiment/circle.png"></img>
                    </div>
                    
                    <p id="status">Not Connected</p>
                    <button onclick="transcribe()">Start Transciption</button>
                    <button onclick="startWorker()">Start Worker</button>
                    <button onclick="stopWorker()">Stop Worker</button>
                </div>
            </div>
        </div>

        
        
        <script>
            function transcribe() {
                navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
            		console.log({ stream });
            		if (!MediaRecorder.isTypeSupported("audio/webm"))
            			return alert("Browser not supported");
            		const mediaRecorder = new MediaRecorder(stream, {
            			mimeType: "audio/webm",
            		});
            		const socket = new WebSocket("wss://api.deepgram.com/v1/listen", [
            									"token",
            									"e7be61060c96f293ab1703011527704193cd5406",
            		]);
            		socket.onopen = () => {
            			document.querySelector("#status").textContent = "Connected";
            			console.log({ event: "onopen" });
            			mediaRecorder.addEventListener("dataavailable", async (event) => {
            				if (event.data.size > 0 && socket.readyState == 1) {
            					socket.send(event.data);
            				}
            			});
            			mediaRecorder.start(1000);
            		};
            
            		socket.onmessage = (message) => {
            			const received = JSON.parse(message.data);
            			const transcript = received.channel.alternatives[0].transcript;
            			if (transcript && received.is_final) {
            				console.log(transcript);
            				document.querySelector("#english-transcript").textContent += transcript + " ";
            			}
            		};
            
            		socket.onclose = () => {
            			console.log({ event: "onclose" });
            		};
            
            		socket.onerror = (error) => {
            			console.log({ event: "onerror", error });
            		};
            	});
            }
        </script>
    </body>
</html>
